---
title: 网络-Https的理解
date: 2019-01-20 16:46:00
categories: 基础
---

## Http有啥问题？
>- 窃听风险（eavesdropping）：第三方可以获知通信内容
>- 篡改风险（tampering）：第三方可以修改通信内容
>- 冒充风险（pretending）：第三方可以冒充他人身份参与通信

SSL/TLS协议是为了解决这三大风险而设计的，希望达到：

>- 所有信息都是加密传播，第三方无法窃听
>- 具有校验机制，一旦被篡改，通信双方会立刻发现
>- 配备身份证书，防止身份被冒充

## Https是个啥？
为了更好地理解 HTTPS，我们来观察一下 HTTPS 的通信步骤。

![ssl握手图](/image/network_https.png)

#### 客户端发出请求（ClientHello）
首先，客户端（通常是浏览器）先向服务器发出加密通信的请求，这被叫做ClientHello请求。
在这一步，客户端主要向服务器提供以下信息。

> （1） 支持的协议版本，比如TLS 1.0版。
> （2） 一个客户端生成的随机数，稍后用于生成"对话密钥"。
> （3） 支持的加密方法，比如RSA公钥加密。
> （4） 支持的压缩方法。

#### 服务器回应（SeverHello）
服务器收到客户端请求后，向客户端发出回应，这叫做SeverHello。服务器的回应包含以下内容。

> （1） 确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。
> （2） 一个服务器生成的随机数，稍后用于生成"对话密钥"。
> （3） 确认使用的加密方法，比如RSA公钥加密。
> （4） 服务器证书。

#### 客户端回应
客户端收到服务器回应以后，首先验证服务器证书。如果证书不是可信机构颁布、或者证书中的域名与实际域名不一致、或者证书已经过期，就会向访问者显示一个警告，由其选择是否还要继续通信。
如果证书没有问题，客户端就会从证书中取出服务器的公钥。然后，向服务器发送下面三项信息。

> （1） 一个随机数。该随机数用服务器公钥加密，防止被窃听。
> （2） 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
> （3） 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供服务器校验。

上面第一项的随机数，是整个握手阶段出现的第三个随机数，又称"pre-master key"。有了它以后，客户端和服务器就同时有了三个随机数，接着双方就用事先商定的加密方法，各自生成本次会话所用的同一把"会话密钥"。

至于为什么一定要用3个随机数，来生成"会话密钥"，dog250解释得很好([参考出处](http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html))：

> "不管是客户端还是服务器，都需要随机数，这样生成的密钥才不会每次都一样。由于SSL协议中证书是静态的，因此十分有必要引入一种随机因素来保证协商出来的密钥的随机性。
> 
> 对于RSA密钥交换算法来说，pre-master-key本身就是一个随机数，再加上hello消息中的随机，3个随机数通过一个密钥导出器最终导出一个对称密钥。
> 
> pre master的存在在于SSL协议不信任每个主机都能产生完全随机的随机数，如果随机数不随机，那么pre master secret就有可能被猜出来，那么仅适用pre master secret作为密钥就不合适了，因此必须引入新的随机因素，那么客户端和服务器加上pre master secret三个随机数一同生成的密钥就不容易被猜出了，一个伪随机可能完全不随机，可是是三个伪随机就十分接近随机了，每增加一个自由度，随机性增加的可不是一。"

#### 服务器的最后回应
服务器收到客户端的第三个随机数pre-master key之后，计算生成本次会话所用的"会话密钥"。然后，向客户端最后发送下面信息。

> （1）编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
> （2）服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供客户端校验。

至此，整个握手阶段全部结束。接下来，客户端与服务器进入加密通信，就完全是使用普通的HTTP协议，只不过用"会话密钥"加密内容。

## Https内容防篡改
HTTPS可以防止中间人的篡改。加密算法的安全性主要分为两种，一种是保护信息不被泄露的能力（CPA安全），一种是保护信息不被篡改的能力（CCA安全）。
单纯的加密算法是不具备防止篡改的能力的。比如AES-CBC加密的某一个消息“早上10点20分发起进攻”，我不需要知道这条消息的具体内容是什么，却可以通过某种手段随意把它改成我指定的时间，比如“早上11点10分发起进攻”。只有结合消息验证机制的加密算法才能防止篡改。比如AES-CBC with HMAC-SHA256、AES-GCM、ChaCha20-Poly1305等等。([参考出处](https://www.zhihu.com/question/65464646))

## Https的延迟
通过下面实验，可以看到ssl握手时间是tcp握手的3倍。([参考出处](http://www.ruanyifeng.com/blog/2014/09/ssl-latency.html))

```shell
$ curl -w "TCP handshake: %{time_connect}, SSL handshake: %{time_appconnect}\n" -so /dev/null https://www.alipay.com

TCP handshake: 0.022, SSL handshake: 0.064
```


## 参考
http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html
http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html
http://www.ruanyifeng.com/blog/2011/02/seven_myths_about_https.html
http://www.ruanyifeng.com/blog/2016/08/migrate-from-http-to-https.html
http://www.ruanyifeng.com/blog/2014/09/ssl-latency.html
https://blog.csdn.net/AloneSword/article/details/47059945